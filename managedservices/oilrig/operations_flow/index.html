<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-root" content="/pubdocstest">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.5.0.770244693232">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.5.0">

    <!-- Primary Meta Tags -->
    <title>Emulation Scenario &#128214;</title>
    <meta name="title" content="Emulation Scenario 📖">
    <meta name="description" content="Based on open-source intelligence, the ATT&CK ® Evaluations team created the below scenario leveraging techniques seen from Oilrig in the wild.">

    <!-- Canonical -->
    <link rel="canonical" href="https://m3mike.github.io/pubdocstest/managedservices/oilrig/operations_flow/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://m3mike.github.io/pubdocstest/managedservices/oilrig/operations_flow/">
    <meta property="og:title" content="Emulation Scenario 📖">
    <meta property="og:description" content="Based on open-source intelligence, the ATT&CK ® Evaluations team created the below scenario leveraging techniques seen from Oilrig in the wild.">
    <meta property="og:image" content="https://m3mike.github.io/pubdocstest/managedservices/oilrig/resources/images/opsflow.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://m3mike.github.io/pubdocstest/managedservices/oilrig/operations_flow/">
    <meta property="twitter:title" content="Emulation Scenario 📖">
    <meta property="twitter:description" content="Based on open-source intelligence, the ATT&CK ® Evaluations team created the below scenario leveraging techniques seen from Oilrig in the wild.">
    <meta property="twitter:image" content="https://m3mike.github.io/pubdocstest/managedservices/oilrig/resources/images/opsflow.png">

    <script data-cfasync="false">(function () { var el = document.documentElement, m = localStorage.getItem("doc_theme"), wm = window.matchMedia; if (m === "dark" || (!m && wm && wm("(prefers-color-scheme: dark)").matches)) { el.classList.add("dark") } else { el.classList.remove("dark") } })();</script>

    <link href="../../../resources/css/retype.css?v=3.5.0.770244693232" rel="stylesheet">

    <script data-cfasync="false" src="../../../resources/js/config.js?v=3.5.0.770244693232" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../../../resources/js/retype.js?v=3.5.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../../../resources/js/lunr.js?v=3.5.0.770244693232" data-turbo-eval="false" defer></script>
</head>
<body>
    <div id="docs-app" class="relative text-base antialiased text-gray-700 bg-white font-body dark:bg-dark-850 dark:text-dark-300">
        <div class="absolute bottom-0 left-0 bg-gray-100 dark:bg-dark-800" style="top: 5rem; right: 50%"></div>
    
        <header id="docs-site-header" class="sticky top-0 z-30 flex w-full h-16 bg-white border-b border-gray-200 md:h-20 dark:bg-dark-850 dark:border-dark-650">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton docs-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="docs-sidebar-toggle"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="docs-site-logo" href="../../../" class="flex items-center leading-snug text-xl">
                            <span class="dark:text-white font-semibold line-clamp-1 md:line-clamp-2">ATTACK Evaluation Library</span>
                        </a><span class="hidden px-2 py-1 ml-4 text-sm font-semibold leading-none text-root-logo-label-text bg-root-logo-label-bg rounded-sm md:inline-block">Docs</span>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block dark:border-dark-650"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://retype.com/guides/getting-started/">Getting Started</a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-gray-400 transition-colors duration-200 ease-in bg-gray-200 border border-transparent rounded md:text-sm hover:bg-white hover:border-gray-300 focus:outline-none focus:bg-white focus:border-gray-500 dark:bg-dark-600 dark:border-dark-600 dark:placeholder-dark-400" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="docs-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
        <div class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-gray-100 border-gray-200 sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton dark:bg-dark-800 dark:border-dark-650">
            
                <!-- Render this div, if config.showSidebarFilter is `true` -->
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-white border border-gray-200 rounded shadow-none text-sm focus:outline-none focus:border-gray-600 dark:bg-dark-600 dark:border-dark-600" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-dark-650">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-dark-650">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-dark-650">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://retype.com/guides/getting-started/">Getting Started</a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 dark:bg-dark-850">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="docs-markdown" id="docs-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="docs-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<p>Based on open-source intelligence, the ATT&amp;CK ® Evaluations team created the below scenario leveraging techniques seen from Oilrig in the wild. We have adapted the scenario based on tools and resources available at the time. Below is a diagram, <doc-anchor-trigger to="#emulation-scenario">scenario overview</doc-anchor-trigger>, <doc-anchor-trigger to="#scenario-steps">step-by-step breakdown</doc-anchor-trigger>, and an <doc-anchor-trigger to="#infrastructure-diagram">infrastructure diagram</doc-anchor-trigger>.</p>
<doc-anchor-target id="emulation-scenario" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#emulation-scenario">#</doc-anchor-trigger>
        <span>Emulation Scenario <span class="docs-emoji">&#x1F4D6;</span></span>
    </h1>
</doc-anchor-target>
<p>This scenario follows OilRig’s multi-phase approach to exfiltrating sensitive data from a targeted server. OilRig leverages spearphishing to gain initial access onto an administrator’s workstation and deploys their SideTwist malware. Once persistence is established on the victim network, the attackers will escalate privileges and move laterally onto an EWS server. Further enumeration of the EWS server will lead to OilRig’s identification of a SQL server storing confidential critical infrastructure data. Characteristics of this campaign include: custom webshells, Windows and Microsoft 365 exploitation, and key attacker objective on obtaining control of the SQL server to steal victim files.<br>
<br><strong>Phase 1:</strong> This scenario begins with the legitimate user Gosta downloading and opening a malicious Word document sent via spearphishing. When the document is first opened, the enabled macros will stealthily install the SideTwist backdoor on Gosta’s Windows host machine. SideTwist connects to a C2 server using GET &amp; POST requests, with responses hidden in the source code of an NotFlickr page. After performing initial enumeration on Gosta’s device, OilRig discovers that the user is a member of the administrator group on an Exchange Web Server (EWS).<br>
<br><strong>Phase 2:</strong> The SideTwist backdoor harvests credentials and collects Gosta&#x27;s password using VALUEVAULT, a credential theft tool. Using Gosta’s stolen EWS credentials, the attackers establish a remote connection to EWS via RDP tunneling. Once connected to the EWS, OilRig deploys the TwoFace webshell on the server to gain access to additional resources on the network. The use of TwoFace to perform enumeration on the EWS will lead attackers to discover a SQL server.<br>
<br><strong>Phase 3:</strong> Next, OilRig will use the TwoFace webshell to download Mimikatz and dump the credentials of targeted administrators on the EWS. Using the stolen credentials of Tous, an SQL admin, the adversary will perform pass-the-hash to move laterally onto the targeted SQL server. This signals the start of the data exfiltration phase. The attackers will gain persistent access to the database through the custom RDAT backdoor, copy the database backup files and exfiltrate them via the EWS API to an attacker-controlled mailbox.
<br><br></p>
<p><figure class="content-center">
    <img src="../resources/images/opsflow.png" alt="Operations Flow Diagram">
    <figcaption class="caption">Operations Flow Diagram</figcaption>
</figure>
</p>
<p><figure class="content-center">
    <img src="../resources/images/softwareflow.png" alt="Software Flow Diagram">
    <figcaption class="caption">Software Flow Diagram</figcaption>
</figure>
</p>
<doc-anchor-target id="scenario-steps">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#scenario-steps">#</doc-anchor-trigger>
        <span>Scenario Steps<span class="docs-emoji">&#x1F463;</span></span>
    </h1>
</doc-anchor-target>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Steps</th>
<th>User Story</th>
<th>Software</th>
<th>Reporting</th>
</tr>
</thead>
<tbody>
<tr>
<td>Step 1 <br> (Initial Compromise &amp; Persistence) <br><a href="https://attack.mitre.org/versions/v11/techniques/T1566/002">T1566.002</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1204/002">T1204.002</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1059/005/">T1059.005</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1082/">T1082</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1033/">T1033</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1497/001/">T1497.001</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1027/">T1027</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1105/">T1105</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1036/">T1036</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1083/">T1083</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1053/005/">T1053.005</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1016/">T1016</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1071/001/">T1071.001</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1573/001/">T1573.001</a></td>
<td>OilRig gains initial access from user Gosta (<code v-pre>THE BLOCK</code>, <code v-pre>10.1.0.5</code>) downloading and opening a Microsoft Word document received from a spearphishing email. Once Gosta enables the malicious macros embedded in the document, the SideTwist payload is stealthily dropped onto the system. The executable is initially named <code v-pre>b.doc</code> and will later be renamed to <code v-pre>SystemFailureReporter.exe</code>. <br><br>OilRig then will use SideTwist to conduct initial discovery on the Windows host machine (<code v-pre>THE BLOCK</code>) and connect to the C2 server over XOR encrypted protocol HTTP on port 443. The attackers C2 infrastructure consists of an HTTP server that hosts a dummy <code v-pre>NotFlickr</code> page. Commands with SideTwist are embedded between <code v-pre>&lt;script&gt;</code> tags on this webpage. <br><br> <strong>Analyst Note:</strong> The document is pre-positioned in the environment. We do not emulate sending the document to target, as our focus is evaluating their product against post-initial-access TTPs.</td>
<td>SideTwist</td>
<td><a href="https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/">https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/</a>  <br><br> <a href="https://www.intezer.com/blog/malware-analysis/new-iranian-campaign-tailored-to-us-companies-uses-updated-toolset/">https://www.intezer.com/blog/malware-analysis/new-iranian-campaign-tailored-to-us-companies-uses-updated-toolset/</a></td>
</tr>
<tr>
<td>Step 2 <br>(Workstation Discovery) <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1059/003/">T1059.003</a><br> <a href="https://attack.mitre.org/versions/v11/techniques/T1033/">T1033</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1082/">T1082</a> <br><a href="https://attack.mitre.org/versions/v11/techniques/T1016/">T1016</a> <br><a href="https://attack.mitre.org/versions/v11/techniques/T1087/002/">T1087.002</a> <br><a href="https://attack.mitre.org/versions/v11/techniques/T1069/002/">T1069.002</a> <br><a href="https://attack.mitre.org/versions/v11/techniques/T1201/">T1201</a> <br><a href="https://attack.mitre.org/versions/v11/techniques/T1087/001/">T1087.001</a> <br><a href="https://attack.mitre.org/versions/v11/techniques/T1069/001/">T1069.001</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1049/">T1049</a> <br><a href="https://attack.mitre.org/versions/v11/techniques/T1057/">T1057</a> <br><a href="https://attack.mitre.org/versions/v11/techniques/T1007/">T1007</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1012/">T1012</a><br> <a href="https://attack.mitre.org/versions/v11/techniques/T1018/">T1018</a><br></td>
<td>OilRig utilizes SideTwist to perform a string of initial enumeration commands via the command line. Specifically, the adversary enumerates the current user, system information and configuration, domain users, domain groups, domain accounts, local groups, network connections, running processes, running services, and a registry key value to check if RDP is enabled.<br><br>At this point, OilRig has discovered the following: the current user Gosta is a member of the EWS Admins group, the presence of an EWS server (<code v-pre>WATERFALLS</code>,<code v-pre>10.1.0.6</code>) on the network which is a part of the Exchange Trusted Subsystem group, and the existence of several other administrator groups (including SQL Admins, of which user Tous is a member).</td>
<td>SideTwist</td>
<td>SideTwist <br> <a href="https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/">https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/</a> <br> VBA coding/macros <br> <a href="https://www.intezer.com/blog/malware-analysis/new-iranian-campaign-tailored-to-us-companies-uses-updated-toolset/">https://www.intezer.com/blog/malware-analysis/new-iranian-campaign-tailored-to-us-companies-uses-updated-toolset/</a> <br> Enumeration <br> <a href="https://unit42.paloaltonetworks.com/the-oilrig-campaign-attacks-on-saudi-arabian-organizations-deliver-helminth-backdoor/">https://unit42.paloaltonetworks.com/the-oilrig-campaign-attacks-on-saudi-arabian-organizations-deliver-helminth-backdoor/</a> <br> EWS/Exchange Trusted Subsystem Discovery <br> <a href="https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/%7C">https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/|</a></td>
</tr>
<tr>
<td>Step 3 (Host Discovery &amp; Credential Collection) <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1105/">T1105</a><br> <a href="https://attack.mitre.org/versions/v11/techniques/T1555/004/">T1555.004</a><br> <a href="https://attack.mitre.org/versions/v11/techniques/T1041/">T1041</a></td>
<td>In order to escalate privileges, OilRig will use SideTwist to download VALUEVAULT onto the Gosta’s device. VALUEVAULT will be used to conduct low privilege credential dumping and retrieve the plaintext password for Gosta. The attackers send this data back to the C2, obfuscating communications via HTTP POST requests.</td>
<td>SideTwist VALUEVAULT <br><br> Golang version of “<a href="https://github.com/Shiva108/CTF-notes/blob/dc11ec9dbb44520425b4f16b281940ef03dfca5d/Notes%20VA/privesc_postexploit.md">Windows Vault Password Dumper</a>” <br><br> <a href="http://web.archive.org/web/20190316025511/http://oxid.it/downloads/vaultdump.txt">Source code</a> <br><br> <a href="http://web.archive.org/web/20190425165422/http://www.oxid.it/downloads/vaultdump.zip">Binary</a></td>
<td>SideTwist <br> <a href="https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/">https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/</a> <br>VALUEVAULT <br>https://www.mandiant.com/resources/hard-pass-declining-apt34-invite-to-join-their-professional-network <br> Hard Pass <br>http://web.archive.org/web/20190316025511/http://oxid.it/downloads/vaultdump.txt</td>
</tr>
<tr>
<td>Step 4 (Web Shell Installation) <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1105/">T1105</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1570/">T1570</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1505/003/">T1505.003</a><br> <a href="https://attack.mitre.org/versions/v11/techniques/T1564/001/">T1564.001</a><br> <a href="https://attack.mitre.org/versions/v11/techniques/T1070/004/">T1070.004</a></td>
<td>Using Gosta’s stolen EWS credentials, OilRig installs the TwoFace web shell for persistence on the EWS. This is accomplished by downloading TwoFace (named <code v-pre>contact.aspx</code>) via the SideTwist executable. The attackers will then copy the webshell from Gosta’s Windows workstation to the EWS, obfuscating the activity with <code v-pre>attrib + h.</code> OilRig covers their tracks by deleting TwoFace from Gosta’s user directory.</td>
<td>VALUEVAULT<br> TwoFace Webshell</td>
<td>Plink/SSH commands <br>https://www.opmd.fr/blog/dnspionage-focus-on-internal-actions/ <br>EWS lateral movement<br> <a href="https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/%7C">https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/|</a></td>
</tr>
<tr>
<td>Step 5 (EWS Discovery) <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1505/003/">T1505.003</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1033/">T1033</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1016/">T1016</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1049/">T1049</a></td>
<td>OilRig uses the TwoFace webshell to perform enumeration on the EWS to discover the SQL server (<code v-pre>ENDOFROAD</code>,<code v-pre>10.1.0.7</code>). OilRig first uses the webshell to perform some initial discovery by enumerating the current user, system network configuration and system network connections. At this point, the attackers identify an open connection to the SQL server via a port commonly associated with SQL. <br><br> <strong>Analyst Note:</strong> TwoFace comprises 2 separate webshells - the first is deployed initially to save and load the second webshell, which is the one used to run commands on the compromised server. However, due to team constraints, we deployed a single webshell that can upload/download files and run commands.</td>
<td>TwoFace Webshell</td>
<td>TwoFace<br>https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/ <br> PSExec <br> <a href="https://unit42.paloaltonetworks.com/unit42-striking-oil-closer-look-adversary-infrastructure/%7C">https://unit42.paloaltonetworks.com/unit42-striking-oil-closer-look-adversary-infrastructure/|</a></td>
</tr>
<tr>
<td>Step 6 (Credential Dumping) <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1105/">T1105</a><br> <a href="https://attack.mitre.org/versions/v11/techniques/T1003/001/">T1003.001</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1041/">T1041</a><br> <a href="https://attack.mitre.org/versions/v11/techniques/T1070/004/">T1070.004</a></td>
<td>OilRig uses the webshell to download Mimikatz to the EWS and uses elevated privileges to dump credentials. The dumped credentials, which include those for SQL server administrator Tous, are exfiltrated back to the C2 (<code v-pre>192.168.0.4</code>) via the webshell. After exfiltration is complete, OilRig deletes both Mimikatz and the dumped credentials from the directory on the EWS.</td>
<td>Mimikatz <br> TwoFace Webshell</td>
<td>Network Discovery <br> <a href="https://unit42.paloaltonetworks.com/the-oilrig-campaign-attacks-on-saudi-arabian-organizations-deliver-helminth-backdoor/">https://unit42.paloaltonetworks.com/the-oilrig-campaign-attacks-on-saudi-arabian-organizations-deliver-helminth-backdoor/</a> <br> TwoFace <br> <a href="https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/%7C">https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/|</a></td>
</tr>
<tr>
<td>Step 7 (Lateral Movement to EWS) <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1105/">T1105</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1572/">T1572</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1078/002/">T1078.002</a><br> <a href="https://attack.mitre.org/versions/v11/techniques/T1021/001/">T1021.001</a> <br></td>
<td>OilRig moves laterally onto the EWS via remote port forward using the plink command line tool. The adversary conducts a remote port forward from Gosta’s workstation to the attacking machine to allow RDP access through port 3389 as user Gosta.</td>
<td>TwoFace webshell <br> plink <br> SideTwist</td>
<td>Credential dumping <br> <a href="https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/%7C">https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/|</a></td>
</tr>
<tr>
<td>Step 8 (Lateral Movement to SQL Server) <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1505/003/">T1505.003</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1105/">T1105</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1550/002/">T1550.002</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1059/003/">T1059.003</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1570/">T1570</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1021/002/">T1021.002</a><br><a href="https://attack.mitre.org/versions/v11/techniques/T1569/002/">T1569.002</a><br></td>
<td>Using the credentials collected for the SQL administrator Tous, the attackers move laterally to the SQL server. First, the webshell is used to download PsExec, RDAT, and a newly named Mimikatz to disk.<br><br>Through the tunneled RDP, OilRig will open an elevated command prompt and uses Tous&#x27; NTLM hash to execute a pass-the-hash to spawn a second shell on the EWS.  As the user Tous, OilRig copies the RDAT backdoor to the SQL server and executes PsExec to get a shell on the targeted server.</td>
<td>PSExec <br> TwoFace Webshell <br> RDAT <br> Mimikatz <br> Cmd <br></td>
<td>PSExec <br> <a href="https://unit42.paloaltonetworks.com/unit42-striking-oil-closer-look-adversary-infrastructure/">https://unit42.paloaltonetworks.com/unit42-striking-oil-closer-look-adversary-infrastructure/</a> <br> Pass the Hash <br> <a href="https://www.clearskysec.com/wp-content/uploads/2020/02/ClearSky-Fox-Kitten-Campaign-v1.pdf%7C">https://www.clearskysec.com/wp-content/uploads/2020/02/ClearSky-Fox-Kitten-Campaign-v1.pdf|</a></td>
</tr>
<tr>
<td>Step 9 (SQL Server Discovery, Collection &amp; Exfiltration) <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1083/">T1083</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1074/001/">T1074.001</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1036/006/">T1036.006</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1005/">T1005</a><br> <a href="https://attack.mitre.org/versions/v11/techniques/T1030/">T1030</a> <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1048/003/">T1048.003</a><br> <a href="https://attack.mitre.org/versions/v11/techniques/T1027/">T1027</a></td>
<td>As the user Tous, OilRig uses the command prompt created by the Mimikatz pass the hash to perform discovery of the database backup files on the SQL server. OilRig will collect and exfiltrate the backups of the database files via the EWS API. OilRig first creates a new directory in which to stage the collected data. The attackers will move RDAT to this new directory and rename it as <code v-pre>VMware.exe.</code> The newly named backdoor is used to read the data, split it into 20,000 byte chunks, and exfiltrate it via EWS API to an attacker-controlled email (<code v-pre>sistan@shirinfarhad.com</code>). The stolen data is obfuscated within BMP images attached to the emails sent to the attackers.</td>
<td>cmd<br>Mimikatz<br>RDAT</td>
<td>Discovery <br> <a href="https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/">https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/</a> <br> RDAT/Exfiltration <br> <a href="https://unit42.paloaltonetworks.com/oilrig-novel-c2-channel-steganography/">https://unit42.paloaltonetworks.com/oilrig-novel-c2-channel-steganography/</a> <br>TwoFace <br>https://unit42.paloaltonetworks.com/unit42-twoface-webshell-persistent-access-point-lateral-movement/<br>C2 Communications<br> <a href="https://unit42.paloaltonetworks.com/the-oilrig-campaign-attacks-on-saudi-arabian-organizations-deliver-helminth-backdoor/%7C">https://unit42.paloaltonetworks.com/the-oilrig-campaign-attacks-on-saudi-arabian-organizations-deliver-helminth-backdoor/|</a></td>
</tr>
<tr>
<td>Step 10 (Clean-up &amp; Egress) <br> <a href="https://attack.mitre.org/versions/v11/techniques/T1070/004/">T1070.004</a></td>
<td>Finally, the adversary deletes all artifacts and files from the EWS and SQL server, terminates command prompts, ups and exits the target network.</td>
<td>cmd</td>
<td></td>
</tr>
</tbody>
</table>
</div>
<doc-anchor-target id="infrastructure-diagram">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#infrastructure-diagram">#</doc-anchor-trigger>
        <span>Infrastructure Diagram</span>
    </h1>
</doc-anchor-target>
<p><figure class="content-center">
    <img src="../resources/images/infrastructurediagram.png" alt="Infrastructure Diagram">
    <figcaption class="caption">Infrastructure Diagram</figcaption>
</figure>
</p>

                                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer class="clear-both">
                            
                                <nav class="flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../../../managedservices/oilrig/emulation_plan/infrastructure/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-gray-400 dark:text-dark-400">Previous</span>
                                                <span class="block mt-1">Scenario Infrastructure</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../../../managedservices/oilrig/intelligence_summary/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-gray-400 dark:text-dark-400">Next</span>
                                                <span class="block mt-1">Oil​Rig Intelligence Summary</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div class="border-t dark:border-dark-650 pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between">
                                <div>
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div class="docs-copyright py-2 text-gray-500 dark:text-dark-350 text-sm leading-relaxed"><p>© Copyright 2024. All rights reserved.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-white border-gray-200 lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton dark:bg-dark-850 dark:border-dark-650">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="docs-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "Emulation Scenario 📖", level: 3, icon: "file", hasPrism: false, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
